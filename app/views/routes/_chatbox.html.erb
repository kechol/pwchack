<script>
$(function() {
  var chatbox = new Vue({
    el: "#chatbox",
    data: {
      room_uuid: '',
      new_message_text: '',
      messages: []
    },
    methods: {
      post_text: function() {
        room.text(this.new_message_text);
        this.new_message_text = '';
      },
      post_image: function() {
        // room.image(this.new_message);
      },
      received: function(data) {
        this.messages.push(data.message);
        this.call_intent(data.message);
        this.scrolldown();
      },
      onload: function() {
        var _this = this;
        this.room_uuid = this.$el.attributes['data-uuid'].value;

        $.getJSON("/messages.json?uuid=" + this.room_uuid, function(data) {
          _this.messages = data.messages;
          messages = $('#messages');
          console.log('init messages', JSON.stringify(data.messages));
          _this.scrolldown();

          if(data.messages.length == 0) {
            console.log('init first message', room);
            room.text('Hi, I\'m Homie. Let me navigate you!', true);
          }
        });
      },
      scrolldown: function() {
        setTimeout(function() {
          messages = $('#messages');
          messages.scrollTop(messages[0].scrollHeight);
        }, 100);
      },
      toggle_chatbox: function() {
        $(this.$el).toggleClass('open');
      },
      call_intent: function(message) {
        console.log('call_intent', message.intent);
        this.eventHub.$emit(message.intent, message);
      }
    }
  });

  var cable = ActionCable.createConsumer();
  var room = cable.subscriptions.create({
      channel: 'RoomChannel',
      room: chatbox.$el.attributes['data-uuid'].value
    }, {
    received: function(data) {
      console.log('cable.received', data);
      chatbox.received(data);
    },
    text: function(message, bot_flg) {
      console.log('cable.post', message);
      this.perform('post', { content: { text: message } , bot_flg: bot_flg, intent: 'text' });
    }
  });

  chatbox.onload();
});
</script>
